<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ユーザー削除テスト</title>
    <script src="JS/auth.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f4f4f4;
        }

        input,
        button {
            padding: 8px;
            margin: 5px 0;
            width: 200px;
        }

        #status {
            margin-top: 10px;
            color: green;
        }

        #error {
            margin-top: 10px;
            color: red;
        }

        #usersDiv {
            margin-top: 15px;
            font-weight: bold;
        }

        h1 {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <h1>ユーザー削除テスト</h1>

    <div>
        <input type="text" id="usernameInput" placeholder="削除したいユーザー名">
        <button id="deleteBtn">ユーザー削除</button>
    </div>

    <div>
        <button id="printBtn">すべてのユーザーを表示</button>
        <div id="usersDiv"></div>
    </div>

    <div id="status"></div>
    <div id="error"></div>

    <script>
        const deleteBtn = document.getElementById("deleteBtn");
        const usernameInput = document.getElementById("usernameInput");
        const statusDiv = document.getElementById("status");
        const errorDiv = document.getElementById("error");
        const printBtn = document.getElementById("printBtn");
        const usersDiv = document.getElementById("usersDiv");

        // ---------------- Delete User ----------------
        deleteBtn.addEventListener("click", async () => {
            const username = usernameInput.value.trim();
            statusDiv.textContent = "";
            errorDiv.textContent = "";

            if (!username) {
                errorDiv.textContent = "ユーザー名を入力してください。";
                return;
            }

            try {
                // Check if user exists in localStorage first
                const localUser = localStorage.getItem(`progress_${username}`);
                if (!localUser) {
                    errorDiv.textContent = `ユーザー "${username}" は存在しません。`;
                    return;
                }

                // Attempt deletion from IndexedDB
                const result = await deleteUser(username);
                if (result) {
                    statusDiv.textContent = `ユーザー "${username}" を削除しました。`;
                    usernameInput.value = "";
                    printAllUsers(); // refresh list after deletion
                } else {
                    errorDiv.textContent = `ユーザー "${username}" が存在しません。`;
                }
            } catch (err) {
                console.error(err);
                errorDiv.textContent = `削除中にエラーが発生しました: ${err}`;
            }
        });

        // ---------------- Print All Users ----------------
        const printAllUsers = () => {
            usersDiv.textContent = "";
            const users = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const match = key.match(/^progress_(.+)$/);
                if (match) {
                    users.push(match[1]);
                }
            }

            if (users.length === 0) {
                usersDiv.textContent = "現在、登録ユーザーはいません。";
            } else {
                usersDiv.textContent = "登録ユーザー: " + users.join(", ");
            }
        };

        printBtn?.addEventListener("click", printAllUsers);

        // Show users on page load
        printAllUsers();
    </script>
</body>

</html>